<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§∏‡§Æ‡§Ø - RSS-Based Hybrid Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-custom {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .loading {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #f97316;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 300px;
            background-color: #1f2937;
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.4;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
            padding: 2px 0;
        }
        .lang-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-50 via-white to-blue-50">
    <div class="container mx-auto p-4 max-w-7xl">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-2xl p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-4xl font-bold text-orange-600 mb-2">
                        ‚ö° ‡§∏‡§Æ‡§Ø - RSS-Based Intelligence
                    </h1>
                    <p class="text-gray-600">35-40 Indian Sources | English + Hindi | Hybrid AI</p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-500">Last Update (IST):</div>
                    <div id="lastUpdated" class="text-lg font-semibold text-gray-700">--:--</div>
                    <div id="nextUpdate" class="text-xs text-gray-500 mt-1">Next: --:--</div>
                    <div id="aiStatus" class="text-xs mt-1"></div>
                </div>
            </div>

            <!-- Live Status -->
            <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse-custom"></div>
                        <p class="text-sm text-green-800 font-semibold">
                            üì∞ LIVE: RSS Feeds (Auto-refresh ‡§π‡§∞ 6 ‡§ò‡§Ç‡§ü‡•á)
                        </p>
                    </div>
                    <button onclick="forceRefresh()" class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700">
                        Manual Refresh
                    </button>
                </div>
            </div>

            <!-- Stats -->
            <div id="stats" class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6"></div>

            <!-- Controls -->
            <div class="flex flex-col md:flex-row gap-4">
                <input
                    type="text"
                    id="searchInput"
                    placeholder="News ‡§ñ‡•ã‡§ú‡•á‡§Ç (Hindi/English)..."
                    class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                />
                
                <select id="categoryFilter" class="px-4 py-3 border-2 border-gray-300 rounded-lg">
                    <option value="all">‡§∏‡§≠‡•Ä Categories</option>
                </select>

                <select id="languageFilter" class="px-4 py-3 border-2 border-gray-300 rounded-lg">
                    <option value="all">‡§∏‡§≠‡•Ä Languages</option>
                    <option value="english">English</option>
                    <option value="hindi">Hindi</option>
                </select>

                <button onclick="exportCSV()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                    üì• Export
                </button>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="text-center py-20">
            <div class="loading mx-auto mb-4"></div>
            <p class="text-xl text-gray-600">RSS feeds ‡§∏‡•á news load ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...</p>
            <p class="text-sm text-gray-500 mt-2">35-40 Indian sources processing...</p>
        </div>

        <!-- News Container -->
        <div id="newsContainer" class="space-y-4 hidden"></div>

        <!-- Info Footer -->
        <div class="mt-8 bg-gradient-to-r from-orange-50 to-blue-50 rounded-xl shadow-lg p-6 border-2 border-orange-200">
            <h3 class="text-xl font-bold text-gray-800 mb-3">üéØ RSS System Features:</h3>
            <div class="grid md:grid-cols-2 gap-3 text-sm text-gray-700">
                <div>‚úÖ 35-40 Indian RSS sources</div>
                <div>‚úÖ English + Hindi mix</div>
                <div>‚úÖ Auto-refresh every 6 hours</div>
                <div>‚úÖ Manual refresh available</div>
                <div>‚úÖ India-centric filtering</div>
                <div>‚úÖ Hybrid AI (Rules + Groq)</div>
                <div>‚úÖ Regional coverage</div>
                <div>‚úÖ Completely FREE</div>
            </div>
            
            <div class="mt-4 p-4 bg-white rounded-lg">
                <p class="text-xs text-gray-600">
                    <strong>Sources:</strong> The Hindu, Indian Express, The Wire, Scroll, BBC Hindi, 
                    Down To Earth, Mongabay, Feminism in India, ‡§î‡§∞ 30+ Indian publications
                </p>
            </div>
        </div>
    </div>

    <script>
        let allNews = [];
        let reviewedItems = new Set();
        let lastUpdateTime = null;

        window.onload = () => {
            loadNews();
            // Auto-refresh check ‡§π‡§∞ 30 minutes
            setInterval(checkAndRefresh, 30 * 60 * 1000);
        };

        async function loadNews() {
            const loading = document.getElementById('loading');
            const container = document.getElementById('newsContainer');
            
            loading.classList.remove('hidden');
            container.classList.add('hidden');

            try {
                const response = await fetch('/api/news');
                const data = await response.json();

                if (data.success) {
                    allNews = data.news;
                    lastUpdateTime = new Date(data.last_update || data.timestamp);
                    updateStats();
                    updateCategoryFilter();
                    displayNews();
                    updateTimestamp(data.timestamp);
                    updateAIStatus(data.ai_enabled);
                    updateNextRefreshTime();
                    
                    loading.classList.add('hidden');
                    container.classList.remove('hidden');
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to load news.');
            }
        }

        async function forceRefresh() {
            if (!confirm('Manual refresh ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? (‡§Ø‡§π 1-2 ‡§Æ‡§ø‡§®‡§ü ‡§≤‡•á‡§ó‡§æ)')) {
                return;
            }
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Refreshing...';
            
            try {
                const response = await fetch('/api/refresh');
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ Refresh successful! ${data.total} news items loaded.`);
                    await loadNews();
                } else {
                    alert('‚ùå Refresh failed: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Refresh error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Manual Refresh';
            }
        }

        function checkAndRefresh() {
            if (!lastUpdateTime) return;
            
            const now = new Date();
            const hoursSinceUpdate = (now - lastUpdateTime) / (1000 * 60 * 60);
            
            // If more than 6 hours, auto-refresh
            if (hoursSinceUpdate >= 6) {
                console.log('Auto-refreshing after 6 hours...');
                loadNews();
            }
        }

        function updateNextRefreshTime() {
            if (!lastUpdateTime) return;
            
            const nextRefresh = new Date(lastUpdateTime.getTime() + 6 * 60 * 60 * 1000);
            const elem = document.getElementById('nextUpdate');
            
            const updateCountdown = () => {
                const now = new Date();
                const diff = nextRefresh - now;
                
                if (diff <= 0) {
                    elem.textContent = 'Next: Refreshing...';
                    loadNews();
                    return;
                }
                
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                elem.textContent = `Next refresh in: ${hours}h ${minutes}m`;
            };
            
            updateCountdown();
            setInterval(updateCountdown, 60000); // Update every minute
        }

        function updateStats() {
            const critical = allNews.filter(n => n.score >= 80).length;
            const high = allNews.filter(n => n.score >= 60 && n.score < 80).length;
            const monitor = allNews.filter(n => n.score < 60).length;
            const hindi = allNews.filter(n => n.language === 'hindi').length;
            const english = allNews.filter(n => n.language === 'english').length;

            document.getElementById('stats').innerHTML = `
                <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-500">
                    <p class="text-sm text-gray-600">üî¥ Critical</p>
                    <p class="text-3xl font-bold text-red-600">${critical}</p>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-500">
                    <p class="text-sm text-gray-600">üü° High</p>
                    <p class="text-3xl font-bold text-yellow-600">${high}</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
                    <p class="text-sm text-gray-600">üü¢ Monitor</p>
                    <p class="text-3xl font-bold text-green-600">${monitor}</p>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                    <p class="text-sm text-gray-600">üáÆüá≥ Hindi</p>
                    <p class="text-3xl font-bold text-blue-600">${hindi}</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-500">
                    <p class="text-sm text-gray-600">üá¨üáß English</p>
                    <p class="text-3xl font-bold text-purple-600">${english}</p>
                </div>
            `;
        }

        function updateCategoryFilter() {
            const categories = [...new Set(allNews.map(n => n.category))];
            const select = document.getElementById('categoryFilter');
            
            select.innerHTML = '<option value="all">‡§∏‡§≠‡•Ä Categories</option>';
            categories.forEach(cat => {
                select.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        }

        function updateTimestamp(timestamp) {
            const date = new Date(timestamp);
            document.getElementById('lastUpdated').textContent = 
                date.toLocaleString('hi-IN', {
                    day: 'numeric',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
        }

        function updateAIStatus(enabled) {
            const status = document.getElementById('aiStatus');
            if (enabled) {
                status.innerHTML = '<span class="text-green-600 font-semibold">‚úì AI Enabled</span>';
            } else {
                status.innerHTML = '<span class="text-yellow-600">‚ö† Rules Only</span>';
            }
        }

        function displayNews() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            const language = document.getElementById('languageFilter').value;

            let filtered = allNews.filter(n => {
                const matchSearch = n.title.toLowerCase().includes(search) || 
                                  n.description.toLowerCase().includes(search);
                const matchCategory = category === 'all' || n.category === category;
                const matchLanguage = language === 'all' || n.language === language;
                return matchSearch && matchCategory && matchLanguage;
            });

            const container = document.getElementById('newsContainer');
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-xl p-12 text-center">
                        <p class="text-xl text-gray-500">‡§ï‡•ã‡§à news ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä ‡§á‡§∏ filter ‡§ï‡•á ‡§∏‡§æ‡§•</p>
                    </div>
                `;
            } else {
                container.innerHTML = filtered.map(news => createNewsCard(news)).join('');
            }
        }

        function createNewsCard(news) {
            const urgency = getUrgencyBadge(news.score);
            const isReviewed = reviewedItems.has(news.id);
            
            const breakdownHTML = `
                <div class="breakdown-item">
                    <span>Context:</span><span>${news.breakdown.context}/25</span>
                </div>
                <div class="breakdown-item">
                    <span>India:</span><span>${news.breakdown.india}/20</span>
                </div>
                <div class="breakdown-item">
                    <span>Source:</span><span>${news.breakdown.source}/15</span>
                </div>
                <div class="breakdown-item">
                    <span>Recency:</span><span>${news.breakdown.recency}/15</span>
                </div>
                <div class="breakdown-item">
                    <span>Category:</span><span>${news.breakdown.alignment}/15</span>
                </div>
                <div class="breakdown-item">
                    <span>Semantic:</span><span>${news.breakdown.semantic}/10</span>
                </div>
                <hr style="margin:8px 0;border-color:#4b5563;">
                <div class="breakdown-item">
                    <strong>Rule:</strong><strong>${news.ruleScore}/100</strong>
                </div>
                ${news.aiScore ? `
                <div class="breakdown-item">
                    <strong>AI:</strong><strong>${news.aiScore}/100</strong>
                </div>` : ''}
            `;
            
            const langBadge = news.language === 'hindi' 
                ? '<span class="lang-badge bg-blue-100 text-blue-800">‡§π‡§ø‡§Ç‡§¶‡•Ä</span>'
                : '<span class="lang-badge bg-purple-100 text-purple-800">ENG</span>';
            
            return `
                <div class="bg-white rounded-xl shadow-lg hover:shadow-2xl transition-all p-6 ${isReviewed ? 'opacity-60' : ''}">
                    <div class="flex gap-4">
                        <div class="flex-1">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2 flex-wrap">
                                        <span class="px-3 py-1 rounded-full text-xs font-bold bg-${news.color}-100 text-${news.color}-800">
                                            ${news.category}
                                        </span>
                                        ${langBadge}
                                        <span class="text-xs text-gray-600">‚Ä¢ ${news.source}</span>
                                        <span class="text-xs text-gray-500">‚Ä¢ ${news.publishedAtIST}</span>
                                    </div>
                                    <h2 class="text-xl font-bold text-gray-800 mb-2">${news.title}</h2>
                                </div>
                                
                                <div class="ml-4 text-center tooltip">
                                    <div class="bg-gradient-to-br from-orange-400 to-orange-600 rounded-full w-16 h-16 flex items-center justify-center shadow-lg cursor-help">
                                        <span class="text-2xl font-bold text-white">${news.score}</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Score ‚ÑπÔ∏è</p>
                                    <span class="tooltiptext">${breakdownHTML}</span>
                                </div>
                            </div>

                            <div class="${urgency.color} inline-flex items-center gap-2 px-3 py-1 rounded-full text-white text-sm font-bold mb-3">
                                ${urgency.icon} ${urgency.text}
                            </div>

                            <p class="text-gray-700 mb-4">${news.description}</p>

                            ${news.reasoning && news.reasoning !== 'Low rule score' ? `
                                <div class="mb-4 p-3 bg-purple-50 border-l-4 border-purple-500 rounded">
                                    <p class="text-xs font-semibold text-purple-800 mb-1">ü§ñ AI:</p>
                                    <p class="text-sm text-purple-700">${news.reasoning}</p>
                                </div>
                            ` : ''}

                            <div class="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg mb-4">
                                <div class="tooltip">
                                    <p class="text-xs text-gray-600">Impact: ${news.impactScore}/100</p>
                                    <div class="bg-gray-200 rounded-full h-2 mt-1">
                                        <div class="bg-blue-600 h-2 rounded-full" style="width:${news.impactScore}%"></div>
                                    </div>
                                    <span class="tooltiptext">
                                        <strong>Impact:</strong> ‡§ï‡§ø‡§§‡§®‡•á ‡§≤‡•ã‡§ó ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ‡§ø‡§§<br>
                                        Based on: reach, severity, importance
                                    </span>
                                </div>

                                <div class="tooltip">
                                    <p class="text-xs text-gray-600">Virality: ${news.viralityScore}/100</p>
                                    <div class="bg-gray-200 rounded-full h-2 mt-1">
                                        <div class="bg-purple-600 h-2 rounded-full" style="width:${news.viralityScore}%"></div>
                                    </div>
                                    <span class="tooltiptext">
                                        <strong>Virality:</strong> ‡§ï‡§ø‡§§‡§®‡•Ä ‡§§‡•á‡§ú‡§º‡•Ä ‡§∏‡•á ‡§´‡•à‡§≤‡•á‡§ó‡§æ<br>
                                        Based on: trends, shareability
                                    </span>
                                </div>
                            </div>

                            <div class="flex gap-2 flex-wrap">
                                <a href="${news.url}" target="_blank" 
                                   class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-semibold">
                                    ‡§™‡•Ç‡§∞‡§æ Article ‚Üí
                                </a>
                                <button onclick="toggleReviewed('${news.id}')"
                                        class="px-4 py-2 rounded-lg text-sm font-semibold ${isReviewed ? 'bg-gray-200' : 'bg-green-100 text-green-700'}">
                                    ${isReviewed ? '‚úì Reviewed' : 'Mark'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getUrgencyBadge(score) {
            if (score >= 80) return { color: 'bg-red-500', icon: 'üî¥', text: '‡§§‡•Å‡§∞‡§Ç‡§§' };
            if (score >= 60) return { color: 'bg-yellow-500', icon: 'üü°', text: '‡§ú‡§≤‡•ç‡§¶' };
            return { color: 'bg-green-500', icon: 'üü¢', text: 'Monitor' };
        }

        function toggleReviewed(id) {
            if (reviewedItems.has(id)) {
                reviewedItems.delete(id);
            } else {
                reviewedItems.add(id);
            }
            displayNews();
        }

        function exportCSV() {
            window.location.href = '/api/export';
        }

        document.getElementById('searchInput').addEventListener('input', displayNews);
        document.getElementById('categoryFilter').addEventListener('change', displayNews);
        document.getElementById('languageFilter').addEventListener('change', displayNews);
    </script>
</body>
</html>
